---
import type { StoryData } from "../schema.ts";
import { dynamicImages } from "../lib/images.ts";
import ResponsiveImage from "./ui/ResponsiveImage.astro";
import { Image } from "astro:assets";
import FrameworkBadge from "../components/FrameworkBadge.svelte";
import { tv } from "tailwind-variants";
import clsx from "clsx";
import { frameworks } from "../data/frameworks";

interface Props {
  size?: "default" | "home" | "relative";
  story: {
    id: string;
    data: StoryData;
  };
}
const { story, size } = Astro.props;
const images = dynamicImages(
  import.meta.glob<{
    default: ImageMetadata;
  }>("/src/assets/stories/*.{jpeg,jpg,png,gif,svg}"),
);

const card = tv({
  slots: {
    base: "block overflow-hidden p-2 rounded-3xl transition-all",
    image: "w-full rounded-2xl object-cover",
    badge: "border-l px-4 ml-6 sm:ml-6 sm:px-6",
    title: "",
    body: "flex items-center",
  },
  variants: {
    size: {
      default: {
        base: "bg-transparent sm:bg-highlight",
        image: "aspect-320/180 sm:aspect-512/450",
        badge: "hidden sm:block",
        title: "text-h5",
        body: "px-2 py-6  sm:p-10"
      },
      relative: {
        base: 'p-0',
        image: "aspect-320/180 sm:aspect-344/200 rounded-xl ",
        badge: "hidden",
        title: "text-h5",
        body: "px-2 pt-6"
      },
      home: {
        base: "bg-[#D6FBC40F]",
        image: "aspect-square sm:aspect-704/450",
        title: "text-base sm:text-h5",
        body: "p-5  sm:p-10",
        badge: "border-l-[#EFFEE214]"
      },
    },
  },
  defaultVariants: {
    size: "default",
  },
});
const isDark = size === "home";
const framework = frameworks.find((f) => f.label === story.data.framework);
const classNames = card(Astro.props);
const imageSizes = (function (): [[number, number],[number, number]] {
  switch (Astro.props.size) {
    case "home":
      return [
        [640, 360],
        [512, 450],
      ];
    case "relative":
      return [
        [670, 400],
        [344, 200],
      ]
    default:
      return [
        [600, 600],
        [704, 450],
      ]
  }
})()
---

<a href={`/stories/${story.id}`} class={classNames.base()}>
  <ResponsiveImage
    src={images(story.data.image)}
    class={classNames.image()}
    mobile={imageSizes[0]}
    sm={imageSizes[1]}
    alt=""
  />
  <div class={classNames.body()}>
    <div class="w-full space-y-2">
      <Image
        src={images(story.data.logo)}
        alt=""
        class={clsx("block h-4 w-auto", isDark && "invert")}
      />
      <h3 class={classNames.title()}>{story.data.title}</h3>
    </div>
    {
      framework && (
        <div class={classNames.badge()}>
          <div class="badge flex flex-col gap-2.5 text-center">
            <FrameworkBadge
              client:only
              name={framework.badge}
              class={clsx(
                "mx-auto block size-15",
                isDark && "invert",
              )}
            />
            <div class="text-xxs">{story.data.framework}</div>
          </div>
        </div>
      )
    }
  </div>
</a>
